name: Build LibOpusFile

on: [push, pull_request]

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- DESKTOP (Linux x64) ---
          - name: Linux x86_64
            os: ubuntu-latest
            triplet: x64-linux
            folder: linux_x86_64

          # --- WINDOWS (MinGW) ---
          - name: Windows MinGW x64
            os: windows-latest
            triplet: x64-mingw-static
            setup_cmd: choco install mingw
            extra_cmake_args: '-G "MinGW Makefiles"'
            folder: windows_x86_64

          - name: Windows MinGW x86
            os: windows-latest
            triplet: x86-mingw-static
            setup_cmd: choco install mingw --forcex86
            extra_cmake_args: '-G "MinGW Makefiles"'
            folder: windows_x86

          # --- ANDROID ---
          - name: Android ARM64 (v8a)
            os: ubuntu-latest
            triplet: arm64-android
            extra_cmake_args: "-DANDROID_ABI=arm64-v8a -DANDROID_PLATFORM=android-24"
            folder: android_abi_arm64_v8a

          # ANDROID ARM32 (v7a) - The Fix Target
          - name: Android ARM32 (v7a)
            os: ubuntu-latest
            triplet: arm-android
            # We enable a specific patch flag for this job
            patch_android_arm: true
            extra_cmake_args: "-DANDROID_ABI=armeabi-v7a -DANDROID_PLATFORM=android-24"
            folder: android_abi_armeabi_v7a

          - name: Android x86_64
            os: ubuntu-latest
            triplet: x64-android
            extra_cmake_args: "-DANDROID_ABI=x86_64 -DANDROID_PLATFORM=android-24"
            folder: android_abi_x86_64

          - name: Android x86
            os: ubuntu-latest
            triplet: x86-android
            extra_cmake_args: "-DANDROID_ABI=x86 -DANDROID_PLATFORM=android-24"
            folder: android_abi_x86

          # --- iOS ---
          - name: iOS ARM64 (Device)
            os: macos-latest
            triplet: arm64-ios
            extra_cmake_args: "-DCMAKE_SYSTEM_NAME=iOS"
            folder: ios_iphoneos_arm64

          - name: iOS Simulator (x64)
            os: macos-latest
            triplet: x64-ios
            extra_cmake_args: "-DCMAKE_SYSTEM_NAME=iOS"
            folder: ios_iphonesimulator_x86_64

          - name: iOS Simulator (ARM64)
            os: macos-latest
            triplet: arm64-ios-simulator
            extra_cmake_args: "-DCMAKE_SYSTEM_NAME=iOS"
            folder: ios_iphonesimulator_arm64

          # --- macOS ---
          - name: macOS ARM64 (Apple Silicon)
            os: macos-latest
            triplet: arm64-osx
            folder: macosx_arm64

          - name: macOS x64 (Intel)
            os: macos-latest
            triplet: x64-osx
            folder: macosx_x86_64

          # --- CROSS-COMPILE LINUX ---
          - name: Linux ARM64 (aarch64)
            os: ubuntu-latest
            triplet: arm64-linux
            setup_cmd: |
              sudo apt-get update
              sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
            cross_cc: aarch64-linux-gnu-gcc
            cross_cxx: aarch64-linux-gnu-g++
            folder: linux_arm64

          # Linux ARM 32-bit (armhf)
          - name: Linux ARM (armhf)
            os: ubuntu-latest
            triplet: arm-linux
            setup_cmd: |
              sudo apt-get update
              sudo apt-get install -y gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf
            cross_cc: arm-linux-gnueabihf-gcc
            cross_cxx: arm-linux-gnueabihf-g++
            patch_opus: true
            folder: linux_arm

          - name: Linux RISC-V 64
            os: ubuntu-latest
            triplet: riscv64-linux
            setup_cmd: |
              sudo apt-get update
              sudo apt-get install -y gcc-riscv64-linux-gnu g++-riscv64-linux-gnu
            cross_cc: riscv64-linux-gnu-gcc
            cross_cxx: riscv64-linux-gnu-g++
            folder: linux_riscv64

    env:
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install System Dependencies
        if: matrix.setup_cmd
        run: ${{ matrix.setup_cmd }}

      - name: Setup Vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git $VCPKG_ROOT
          cd $VCPKG_ROOT
          if [ "${{ runner.os }}" = "Windows" ]; then
            ./bootstrap-vcpkg.bat
          else
            ./bootstrap-vcpkg.sh
          fi

      # --- PATCH 1: Linux ARM32 (Opus Intrinsics) ---
      - name: Patch Opus for Linux ARM32
        if: matrix.patch_opus
        run: |
          echo "Patching Opus portfile to disable intrinsics on ARM32..."
          PORTFILE="$VCPKG_ROOT/ports/opus/portfile.cmake"
          sed -i 's/vcpkg_cmake_configure(/vcpkg_cmake_configure(OPTIONS -DOPUS_DISABLE_INTRINSICS=ON /g' "$PORTFILE"
          cat "$PORTFILE"

      # --- PATCH 2: Android ARM32 (Force NEON) ---
      - name: Patch Triplet for Android ARM32
        if: matrix.patch_android_arm
        run: |
          echo "Patching arm-android triplet to force NEON..."
          TRIPLET_FILE="$VCPKG_ROOT/triplets/community/arm-android.cmake"
          
          # Append the CMake flag to VCPKG_CMAKE_CONFIGURE_OPTIONS inside the triplet file
          echo 'set(VCPKG_CMAKE_CONFIGURE_OPTIONS "-DANDROID_ARM_NEON=ON")' >> "$TRIPLET_FILE"
          
          echo "--- PATCHED TRIPLET ---"
          cat "$TRIPLET_FILE"

      - name: Install Dependencies
        run: |
          # 1. Install Host Tools FIRST
          $VCPKG_ROOT/vcpkg install vcpkg-cmake --triplet=x64-linux --host-triplet=x64-linux || true
          
          # 2. Set Cross Compilers
          if [ ! -z "${{ matrix.cross_cc }}" ]; then
            export CC=${{ matrix.cross_cc }}
            export CXX=${{ matrix.cross_cxx }}
          fi
          
          # 3. Install Libraries
          $VCPKG_ROOT/vcpkg install libogg opus --triplet ${{ matrix.triplet }}

      - name: Configure CMake
        run: |
          if [ ! -z "${{ matrix.cross_cc }}" ]; then
            export CC=${{ matrix.cross_cc }}
            export CXX=${{ matrix.cross_cxx }}
          fi

          cmake -B build -S . \
            -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
            -DVCPKG_TARGET_TRIPLET=${{ matrix.triplet }} \
            -DCMAKE_BUILD_TYPE=Release \
            -DOP_DISABLE_HTTP=ON \
            -DOP_DISABLE_EXAMPLES=ON \
            -DOP_DISABLE_DOCS=ON \
            ${{ matrix.extra_cmake_args }}

      - name: Build
        run: cmake --build build --config Release

      - name: Merge Libraries
        run: |
          # 1. Define Paths
          VCPKG_LIB_DIR="$VCPKG_ROOT/installed/${{ matrix.triplet }}/lib"
          BUILD_DIR="$(pwd)/build"
          
          # 2. Find input libraries
          LIBOGG=$(find "$VCPKG_LIB_DIR" -name "*ogg.a" -o -name "*ogg.lib" | head -n 1)
          LIBOPUS=$(find "$VCPKG_LIB_DIR" -name "*opus.a" -o -name "*opus.lib" | head -n 1)
          LIBOPUSFILE=$(find "$BUILD_DIR" -name "*opusfile.a" -o -name "*opusfile.lib" | head -n 1)

          echo "Found libraries:"
          echo "  - Ogg: $LIBOGG"
          echo "  - Opus: $LIBOPUS"
          echo "  - OpusFile: $LIBOPUSFILE"

          # 3. Merge Strategy
          if [ "${{ runner.os }}" = "macOS" ]; then
            # macOS: Use libtool
            libtool -static -o "$BUILD_DIR/libopusfile_combined.a" "$LIBOPUSFILE" "$LIBOPUS" "$LIBOGG"

          else
            # Linux / Windows: Use MRI Script (ar -M)
            echo "Using MRI script strategy..."
            
            # Create a clean temp directory to work in
            mkdir -p build/merging
            
            # Copy libraries to the temp folder with simple names
            # This avoids all issues with spaces, backslashes, or drive letters in paths
            cp "$LIBOGG" build/merging/libogg.a
            cp "$LIBOPUS" build/merging/libopus.a
            cp "$LIBOPUSFILE" build/merging/libopusfile.a
            
            cd build/merging

            # Generate the MRI script
            # 'create' makes the new archive
            # 'addlib' merges the contents of the inputs
            echo "create libopusfile_combined.a" > merge.mri
            echo "addlib libogg.a" >> merge.mri
            echo "addlib libopus.a" >> merge.mri
            echo "addlib libopusfile.a" >> merge.mri
            echo "save" >> merge.mri
            echo "end" >> merge.mri
            
            # Execute the script
            ar -M < merge.mri
            
            # Move the result back to build dir
            mv libopusfile_combined.a ../
            
            echo "Success! Created:"
            ls -l ../libopusfile_combined.a
          fi

      - name: Organize Artifacts
        run: |
          # 1. Define and Create Target Folder
          FOLDER_NAME="${{ matrix.folder }}"
          TARGET="staging/$FOLDER_NAME"
          mkdir -p "$TARGET"
          
          echo "Organizing artifacts into $TARGET..."

          # 2. Define Source Paths
          VCPKG_LIB_DIR="$VCPKG_ROOT/installed/${{ matrix.triplet }}/lib"
          BUILD_DIR="$(pwd)/build"

          # 3. Find Files (again, to be safe across steps)
          # We use generic wildcards to catch .a (Linux/Mac/MinGW) or .lib (Windows MSVC if used later)
          LIBOGG=$(find "$VCPKG_LIB_DIR" -name "*ogg.a" -o -name "*ogg.lib" | head -n 1)
          LIBOPUS=$(find "$VCPKG_LIB_DIR" -name "*opus.a" -o -name "*opus.lib" | head -n 1)
          LIBOPUSFILE=$(find "$BUILD_DIR" -name "*opusfile.a" -o -name "*opusfile.lib" | head -n 1)
          COMBINED=$(find "$BUILD_DIR" -name "*combined.a" -o -name "*combined.lib" | head -n 1)

          # 4. Copy to Target Folder
          if [ -f "$LIBOGG" ]; then cp "$LIBOGG" "$TARGET/"; else echo "Warning: Ogg not found"; fi
          if [ -f "$LIBOPUS" ]; then cp "$LIBOPUS" "$TARGET/"; else echo "Warning: Opus not found"; fi
          if [ -f "$LIBOPUSFILE" ]; then cp "$LIBOPUSFILE" "$TARGET/"; else echo "Warning: OpusFile not found"; fi
          if [ -f "$COMBINED" ]; then cp "$COMBINED" "$TARGET/"; else echo "Warning: Combined lib not found"; fi

          echo "Contents of $TARGET:"
          ls -l "$TARGET"

      - name: Upload Binaries
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.folder }}
          path: staging/
