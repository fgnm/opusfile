name: Build LibOpusFile

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- DESKTOP (Linux x64) ---
          - name: Linux x86_64
            os: ubuntu-latest
            triplet: x64-linux
            # No extra setup needed for native linux

          # --- WINDOWS (MinGW) ---
          - name: Windows MinGW x64
            os: windows-latest
            triplet: x64-mingw-static
            setup_cmd: choco install mingw

          - name: Windows MinGW x86
            os: windows-latest
            triplet: x86-mingw-static
            setup_cmd: choco install mingw --forcex86

          # --- ANDROID ---
          - name: Android ARM64
            os: ubuntu-latest
            triplet: arm64-android
            extra_cmake_args: "-DANDROID_ABI=arm64-v8a -DANDROID_PLATFORM=android-24"

          # --- iOS ---
          - name: iOS ARM64
            os: macos-latest
            triplet: arm64-ios
            extra_cmake_args: "-DCMAKE_SYSTEM_NAME=iOS"

          - name: iOS Simulator (x64)
            os: macos-latest
            triplet: x64-ios
            extra_cmake_args: "-DCMAKE_SYSTEM_NAME=iOS"

          # --- macOS ---
          - name: macOS ARM64 (Apple Silicon)
            os: macos-latest
            triplet: arm64-osx

          - name: macOS x64 (Intel)
            os: macos-latest
            triplet: x64-osx

          # --- CROSS-COMPILE LINUX (The tricky ones) ---
          # Vcpkg 'community' triplets for Linux cross-compile require 
          # us to install the GCC cross-compilers on the runner first.
          - name: Linux ARM64 (aarch64)
            os: ubuntu-latest
            triplet: arm64-linux
            setup_cmd: |
              sudo apt-get update
              sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
            env_vars: "CC=aarch64-linux-gnu-gcc CXX=aarch64-linux-gnu-g++"

          - name: Linux ARM (armhf)
            os: ubuntu-latest
            triplet: arm-linux
            setup_cmd: |
              sudo apt-get update
              sudo apt-get install -y gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf
            env_vars: "CC=arm-linux-gnueabihf-gcc CXX=arm-linux-gnueabihf-g++"

          - name: Linux RISC-V 64
            os: ubuntu-latest
            triplet: riscv64-linux
            setup_cmd: |
              sudo apt-get update
              sudo apt-get install -y gcc-riscv64-linux-gnu g++-riscv64-linux-gnu
            env_vars: "CC=riscv64-linux-gnu-gcc CXX=riscv64-linux-gnu-g++"

    env:
      # Tell vcpkg where to install packages
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg

    steps:
      - uses: actions/checkout@v3

      # 1. Install System Dependencies (Cross Compilers or MinGW tools)
      - name: Install System Dependencies
        if: matrix.setup_cmd
        run: ${{ matrix.setup_cmd }}
        shell: bash

      # 2. Setup Vcpkg
      - name: Setup Vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: 'master' # Uses latest vcpkg
          vcpkgDirectory: ${{ github.workspace }}/vcpkg

      # 3. Install Dependencies (Ogg, Opus) using Vcpkg
      # This builds libogg and libopus for the specific target architecture
      - name: Install Dependencies
        run: |
          # Export CC/CXX for Linux cross-compiles if defined in matrix
          ${{ matrix.env_vars }}
          
          # Install dependencies for the requested triplet
          $VCPKG_ROOT/vcpkg install libogg libopus --triplet ${{ matrix.triplet }}

      # 4. Configure CMake
      - name: Configure CMake
        run: |
          # Use the vcpkg toolchain file so CMake can find the deps we just built
          cmake -B build -S . \
            -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake \
            -DVCPKG_TARGET_TRIPLET=${{ matrix.triplet }} \
            -DCMAKE_BUILD_TYPE=Release \
            -DOP_DISABLE_HTTP=ON \
            -DOP_DISABLE_EXAMPLES=ON \
            -DOP_DISABLE_DOCS=ON \
            ${{ matrix.extra_cmake_args }}

      # 5. Build
      - name: Build
        run: cmake --build build --config Release

      # 6. Upload Artifacts
      - name: Upload Binaries
        uses: actions/upload-artifact@v4
        with:
          name: libopusfile-${{ matrix.name }}
          path: |
            build/*.a
            build/*.so
            build/*.dylib
            build/*.dll
            build/Release/*.lib
