name: Build LibOpusFile

on: [push, pull_request]

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- DESKTOP (Linux x64) ---
          - name: Linux x86_64
            os: ubuntu-latest
            triplet: x64-linux

          # --- WINDOWS (MinGW) ---
          - name: Windows MinGW x64
            os: windows-latest
            triplet: x64-mingw-static
            setup_cmd: choco install mingw
            extra_cmake_args: '-G "MinGW Makefiles"'

          - name: Windows MinGW x86
            os: windows-latest
            triplet: x86-mingw-static
            setup_cmd: choco install mingw --forcex86
            extra_cmake_args: '-G "MinGW Makefiles"'

          # --- ANDROID (The Full Set) ---
          - name: Android ARM64 (v8a)
            os: ubuntu-latest
            triplet: arm64-android
            extra_cmake_args: "-DANDROID_ABI=arm64-v8a -DANDROID_PLATFORM=android-24"

          - name: Android ARM32 (v7a)
            os: ubuntu-latest
            triplet: arm-android
            extra_cmake_args: "-DANDROID_ABI=armeabi-v7a -DANDROID_PLATFORM=android-24"

          - name: Android x86_64
            os: ubuntu-latest
            triplet: x64-android
            extra_cmake_args: "-DANDROID_ABI=x86_64 -DANDROID_PLATFORM=android-24"

          - name: Android x86
            os: ubuntu-latest
            triplet: x86-android
            extra_cmake_args: "-DANDROID_ABI=x86 -DANDROID_PLATFORM=android-24"

          # --- iOS ---
          - name: iOS ARM64 (Device)
            os: macos-latest
            triplet: arm64-ios
            extra_cmake_args: "-DCMAKE_SYSTEM_NAME=iOS"

          - name: iOS Simulator (x64)
            os: macos-latest
            triplet: x64-ios
            extra_cmake_args: "-DCMAKE_SYSTEM_NAME=iOS"

          - name: iOS Simulator (ARM64)
            os: macos-latest
            triplet: arm64-ios-simulator
            extra_cmake_args: "-DCMAKE_SYSTEM_NAME=iOS"

          # --- macOS ---
          - name: macOS ARM64 (Apple Silicon)
            os: macos-latest
            triplet: arm64-osx

          - name: macOS x64 (Intel)
            os: macos-latest
            triplet: x64-osx

          # --- CROSS-COMPILE LINUX ---
          - name: Linux ARM64 (aarch64)
            os: ubuntu-latest
            triplet: arm64-linux
            setup_cmd: |
              sudo apt-get update
              sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
            cross_cc: aarch64-linux-gnu-gcc
            cross_cxx: aarch64-linux-gnu-g++

          # THE SPECIAL CASE: Linux ARM 32-bit (Requires Patch)
          - name: Linux ARM (armhf)
            os: ubuntu-latest
            triplet: arm-linux
            setup_cmd: |
              sudo apt-get update
              sudo apt-get install -y gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf
            cross_cc: arm-linux-gnueabihf-gcc
            cross_cxx: arm-linux-gnueabihf-g++
            # Only enable the patch for this specific job
            patch_opus: true

          - name: Linux RISC-V 64
            os: ubuntu-latest
            triplet: riscv64-linux
            setup_cmd: |
              sudo apt-get update
              sudo apt-get install -y gcc-riscv64-linux-gnu g++-riscv64-linux-gnu
            cross_cc: riscv64-linux-gnu-gcc
            cross_cxx: riscv64-linux-gnu-g++

    env:
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install System Dependencies
        if: matrix.setup_cmd
        run: ${{ matrix.setup_cmd }}

      - name: Setup Vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git $VCPKG_ROOT
          cd $VCPKG_ROOT
          if [ "${{ runner.os }}" = "Windows" ]; then
            ./bootstrap-vcpkg.bat
          else
            ./bootstrap-vcpkg.sh
          fi

      # --- PATCH STEP (Only runs for Linux armhf) ---
      - name: Patch Opus for ARM32 Linux
        if: matrix.patch_opus
        run: |
          echo "Patching Opus portfile to disable intrinsics on ARM32..."
          PORTFILE="$VCPKG_ROOT/ports/opus/portfile.cmake"
          
          # Replace the function call start to inject the option
          sed -i 's/vcpkg_cmake_configure(/vcpkg_cmake_configure(OPTIONS -DOPUS_DISABLE_INTRINSICS=ON /g' "$PORTFILE"
          
          echo "--- PATCHED PORTFILE CONTENT ---"
          cat "$PORTFILE"

      - name: Install Dependencies
        run: |
          # 1. Install Host Tools FIRST (Standard x64)
          $VCPKG_ROOT/vcpkg install vcpkg-cmake --triplet=x64-linux --host-triplet=x64-linux || true
          
          # 2. Set Cross Compilers (if defined in matrix)
          if [ ! -z "${{ matrix.cross_cc }}" ]; then
            export CC=${{ matrix.cross_cc }}
            export CXX=${{ matrix.cross_cxx }}
          fi
          
          # 3. Install Libraries for Target
          $VCPKG_ROOT/vcpkg install libogg opus --triplet ${{ matrix.triplet }}

      - name: Configure CMake
        run: |
          if [ ! -z "${{ matrix.cross_cc }}" ]; then
            export CC=${{ matrix.cross_cc }}
            export CXX=${{ matrix.cross_cxx }}
          fi

          cmake -B build -S . \
            -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
            -DVCPKG_TARGET_TRIPLET=${{ matrix.triplet }} \
            -DCMAKE_BUILD_TYPE=Release \
            -DOP_DISABLE_HTTP=ON \
            -DOP_DISABLE_EXAMPLES=ON \
            -DOP_DISABLE_DOCS=ON \
            ${{ matrix.extra_cmake_args }}

      - name: Build
        run: cmake --build build --config Release

      - name: Upload Binaries
        uses: actions/upload-artifact@v4
        with:
          name: libopusfile-${{ matrix.name }}
          path: |
            build/*.a
            build/*.so
            build/*.dylib
            build/*.dll
            build/Release/*.lib
            build/Release/*.dll
