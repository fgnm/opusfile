name: Build LibOpusFile

on: [push, pull_request]

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- DESKTOP (Linux x64) ---
          - name: Linux x86_64
            os: ubuntu-latest
            triplet: x64-linux

          # --- WINDOWS (MinGW) ---
          # Note: Windows runners are slower to setup
          - name: Windows MinGW x64
            os: windows-latest
            triplet: x64-mingw-static
            setup_cmd: choco install mingw

          - name: Windows MinGW x86
            os: windows-latest
            triplet: x86-mingw-static
            setup_cmd: choco install mingw --forcex86

          # --- ANDROID ---
          - name: Android ARM64
            os: ubuntu-latest
            triplet: arm64-android
            # Vcpkg handles the NDK, but we pass these to ensure CMake knows the target
            extra_cmake_args: "-DANDROID_ABI=arm64-v8a -DANDROID_PLATFORM=android-24"

          # --- iOS ---
          - name: iOS ARM64
            os: macos-latest
            triplet: arm64-ios
            extra_cmake_args: "-DCMAKE_SYSTEM_NAME=iOS"

          - name: iOS Simulator (x64)
            os: macos-latest
            triplet: x64-ios
            extra_cmake_args: "-DCMAKE_SYSTEM_NAME=iOS"

          # --- macOS ---
          - name: macOS ARM64 (Apple Silicon)
            os: macos-latest
            triplet: arm64-osx

          - name: macOS x64 (Intel)
            os: macos-latest
            triplet: x64-osx

          # --- CROSS-COMPILE LINUX ---
          - name: Linux ARM64 (aarch64)
            os: ubuntu-latest
            triplet: arm64-linux
            setup_cmd: |
              sudo apt-get update
              sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
            # specific exports to force vcpkg to use these compilers
            cc_var: aarch64-linux-gnu-gcc
            cxx_var: aarch64-linux-gnu-g++

          - name: Linux ARM (armhf)
            os: ubuntu-latest
            triplet: arm-linux
            setup_cmd: |
              sudo apt-get update
              sudo apt-get install -y gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf
            cc_var: arm-linux-gnueabihf-gcc
            cxx_var: arm-linux-gnueabihf-g++

          - name: Linux RISC-V 64
            os: ubuntu-latest
            triplet: riscv64-linux
            setup_cmd: |
              sudo apt-get update
              sudo apt-get install -y gcc-riscv64-linux-gnu g++-riscv64-linux-gnu
            cc_var: riscv64-linux-gnu-gcc
            cxx_var: riscv64-linux-gnu-g++

    env:
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg

    steps:
      - uses: actions/checkout@v3

      # 1. Install System Compilers (if needed)
      - name: Install System Dependencies
        if: matrix.setup_cmd
        run: ${{ matrix.setup_cmd }}
        shell: bash

      # 2. Manual Vcpkg Setup (The Fix)
      # We clone specifically to a folder and bootstrap it.
      - name: Setup Vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git $VCPKG_ROOT
          cd $VCPKG_ROOT
          # Bootstrap script depends on OS
          if [ "${{ runner.os }}" = "Windows" ]; then
            ./bootstrap-vcpkg.bat
          else
            ./bootstrap-vcpkg.sh
          fi
        shell: bash

      # 3. Install LibOpus and LibOgg
      # We explicitly export CC/CXX so vcpkg uses the cross-compilers for Linux targets
      - name: Install Dependencies
        run: |
          if [ ! -z "${{ matrix.cc_var }}" ]; then
            export CC=${{ matrix.cc_var }}
            export CXX=${{ matrix.cxx_var }}
          fi
          
          $VCPKG_ROOT/vcpkg install libogg libopus --triplet ${{ matrix.triplet }}
        shell: bash

      # 4. Configure CMake
      - name: Configure CMake
        run: |
          cmake -B build -S . \
            -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
            -DVCPKG_TARGET_TRIPLET=${{ matrix.triplet }} \
            -DCMAKE_BUILD_TYPE=Release \
            -DOP_DISABLE_HTTP=ON \
            -DOP_DISABLE_EXAMPLES=ON \
            -DOP_DISABLE_DOCS=ON \
            ${{ matrix.extra_cmake_args }}

      # 5. Build
      - name: Build
        run: cmake --build build --config Release

      # 6. Upload Artifacts
      - name: Upload Binaries
        uses: actions/upload-artifact@v4
        with:
          name: libopusfile-${{ matrix.name }}
          path: |
            build/*.a
            build/*.so
            build/*.dylib
            build/*.dll
            build/Release/*.lib
